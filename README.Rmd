---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  comment = "#",
  fig.path = "man/figures/README-"
)
```

# CoxBoost

<!-- badges: start -->
[![r-cmd-check](https://github.com/binderh/CoxBoost/actions/workflows/r-cmd-check.yml/badge.svg)](https://github.com/binderh/CoxBoost/actions/workflows/r-cmd-check.yml)
[![CRAN Status](https://www.r-pkg.org/badges/version-ago/CoxBoost)](https://cran.r-project.org/package=CoxBoost)
<!-- badges: end -->

Cox-Likelihood Based Boosting for right-censored single-event survival tasks and competing risks.

## Installation

You can install the development version of CoxBoost from [GitHub](https://github.com/binderh/CoxBoost/) with:

``` r
# install.packages("pak")
pak::pak("binderh/CoxBoost")
```

## Examples

We provide two basic examples which show how to fit a `CoxBoost` model and predict on new data.

### Single-event data

First, we generate some survival data with 10 informative covariates and define the train and test sets:
```{r example}
library(CoxBoost)
set.seed(42)

# generate survival data
n = 200; p = 100
beta = c(rep(1,10),rep(0,p-10))
x = matrix(rnorm(n*p),n,p)
real.time = -(log(runif(n)))/(10*exp(drop(x %*% beta)))
cens.time = rexp(n,rate=1/10)
status = ifelse(real.time <= cens.time,1,0)
obs.time = ifelse(real.time <= cens.time,real.time,cens.time)

# define training and test set
train.index = 1:150
test.index = 151:200
```

We fit CoxBoost to the training data and see the model's `summary()`:
```{r}
cbfit = CoxBoost(
  time = obs.time[train.index],
  status = status[train.index],
  x = x[train.index,],
  stepno = 300, penalty = 100
)

summary(cbfit)
```

Plot the mean partial log-likelihood for test set in every boosting step:
```{r}
step_pll = predict(
  cbfit,
  newdata = x[test.index,],
  newtime = obs.time[test.index],
  newstatus = status[test.index],
  at.step = 0:300, type = "logplik"
)

plot(step_pll)
```

Names of covariates with non-zero coefficients at boosting step with maximal test set partial log-likelihood:
```{r}
print(cbfit$xnames[cbfit$coefficients[which.max(step_pll),] != 0])
```

We refit the `CoxBoost` model but with covariates 1 and 2 as mandatory:
```{r}
cbfit_mand = CoxBoost(
  time = obs.time,
  status = status,
  x = x, 
  unpen.index = c(1,2), stepno = 100, penalty = 100
)

summary(cbfit_mand)
```

### Competing risks data

We use the `bpc` dataset from the `survival` package, perform a simple trian/test split and fit a cause-specific hazard CoxBoost model:
```{r}
library(survival)

# Use the pbc dataset from survival package
data(pbc)
# Create a competing risks variable: 0=censored, 1=death, 2=transplant
pbc$status2 = with(pbc, ifelse(status == 0, 0, ifelse(status == 1, 1, 2)))
pbc$sex = with(pbc, ifelse(sex == "m", 0, 1)) # CoxBoost doesn't support factors

# Keep only complete cases for simplicity
pbc2 = na.omit(pbc[, c("time", "status2", "age", "sex", "bili")])

# Train/test split
set.seed(42)
train_index = 1:300 # 300
test_index  = 301:nrow(pbc2) # 118

# Fit CoxBoost with cause-specific hazards
fit = CoxBoost(
  time    = pbc2$time[train_index],
  status  = pbc2$status2[train_index],
  x       = as.matrix(pbc2[train_index, c("age", "sex", "bili")]),
  stepno  = 300,
  penalty = 100,
  cmprsk  = "csh" # cause-specific hazards
)
```

Summary of the trained model:
```{r}
summary(fit)
```

Predict CIFs on the test set using the unique, sorted event (by any cause) time points:
```{r}
times = sort(pbc2$time[test_index][pbc2$status2[test_index] != 0])
cif_pred = predict(
  fit,
  newdata = as.matrix(pbc2[test_index, c("age", "sex", "bili")]),
  type = "CIF",
  times = times
)

str(cif_pred)
```

The output prediction object is a list with two elements: one matrix for each cause (death and transplant), with the cumulative incidence function (CIF).
Each matrix's rows correspond to the test observations and the columns to the time points.

We plot the CIF of the first cause and for the first 3 test patients:
```{r}
matplot(times, t(cif_pred$`1`[1:3, ]), type = "l", lty = 1, col = 1:3,
        xlab = "Time", ylab = "Cumulative Incidence (Cause 1)")
legend("topleft", legend = 1:3, col = 1:3, lty = 1)
```

# Citing CoxBoost

If you apply `CoxBoost` to *single-event* survival data, please cite:
```
@article{Binder2008,
  title = {{A}llowing for mandatory covariates in boosting estimation of sparse high-dimensional survival models},
  author = {Harald Binder and Martin Schumacher},
  doi = {10.1186/1471-2105-9-14},
  issn = {14712105},
  issue = {1},
  journal = {BMC Bioinformatics},
  month = {1},
  pages = {1-10},
  pmid = {18186927},
  publisher = {BioMed Central},
  volume = {9},
  year = {2008}
}
```

If you use `CoxBoost` for *competing risks* analyses, please cite:
```
@article{Binder2009,
  title = {{B}oosting for high-dimensional time-to-event data with competing riks},
  author = {Harald Binder and Arthur Allignol and Martin Schumacher and Jan Beersmann},
  doi = {10.1093/BIOINFORMATICS/BTP088},
  issn = {1367-4803},
  issue = {7},
  journal = {Bioinformatics},
  month = {4},
  pages = {890-896},
  pmid = {19244389},
  publisher = {Oxford Academic},
  volume = {25},
  year = {2009}
}
```
